{# os_app/templates/os_app/editar_os.html #}
{% extends "base.html" %}
{% block content %}

  {# div com endpoints para o scripts.js ler (placeholder /0/ para substituição) #}
  <div id="os-api-urls"
       data-por-proprietario="{% url 'os_app:api_objetos_por_proprietario' 0 %}"
       data-obj-detail="{% url 'os_app:api_objeto_detail' 0 %}"></div>

  <h2 class="h5 mb-3">Editar OS #
    {% if os.idordem %}{{ os.idordem }}{% elif os.id %}{{ os.id }}{% else %}-{% endif %}
  </h2>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    <div class="row g-3">

      {# --- Descrição gerada / Defeito --- #}
      <div class="col-12">
        <label class="form-label">{{ form.descricaoobjeto.label }}</label>
        {{ form.descricaoobjeto }}
        {% if form.descricaoobjeto.errors %}<div class="text-danger small">{{ form.descricaoobjeto.errors }}</div>{% endif %}
      </div>

      <div class="col-12">
        <label class="form-label">{{ form.defeito.label }}</label>
        {{ form.defeito }}
        {% if form.defeito.errors %}<div class="text-danger small">{{ form.defeito.errors }}</div>{% endif %}
      </div>

      {# --- Campos do objeto / vínculo com objeto cadastrado --- #}
      <div class="d-none">
        {% if form.idobjeto %}{{ form.idobjeto }}{% endif %}
      </div>

      <div class="col-md-3">
        <label class="form-label">Tipo</label>
        {% if form.tipo_objeto %}{{ form.tipo_objeto }}{% else %}<input id="id_tipo_objeto" class="form-control">{% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Marca</label>
        {% if form.marca %}{{ form.marca }}{% else %}<input id="id_marca" class="form-control">{% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Modelo</label>
        {% if form.modelo %}{{ form.modelo }}{% else %}<input id="id_modelo" class="form-control">{% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Placa</label>
        {% if form.placa %}{{ form.placa }}{% else %}<input id="id_placa" class="form-control">{% endif %}
      </div>

      {# --- Usuário / Cliente / Email --- #}
      <div class="col-md-4">
        <label class="form-label">{{ form.idusuario.label }}</label>
        {{ form.idusuario }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.nome_cliente.label }}</label>
        {{ form.nome_cliente }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.email_cliente.label }}</label>
        {{ form.email_cliente }}
      </div>

      {# --- Placa/Localização/Proprietário (mantidos) --- #}
      <div class="col-md-4">
        <label class="form-label">{{ form.placa.label }}</label>
        {{ form.placa }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.localizacao.label }}</label>
        {{ form.localizacao }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.proprietario.label }}</label>
        {{ form.proprietario }}
      </div>

      {# --- demais campos --- #}
      <div class="col-md-4">
        <label class="form-label">{{ form.natureza.label }}</label>
        {{ form.natureza }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.cond_pagto.label }}</label>
        {{ form.cond_pagto }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.entrada.label }}</label>
        {{ form.entrada }}
      </div>

      <div class="col-md-4">
        <label class="form-label">{{ form.previsao_data.label }}</label>
        {{ form.previsao_data }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.previsao_hora.label }}</label>
        {{ form.previsao_hora }}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.vendedor.label }}</label>
        {{ form.vendedor }}
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.tecnico.label }}</label>
        {{ form.tecnico }}
      </div>

      <div class="col-12">
        <label class="form-label">{{ form.pertencentes.label }}</label>
        {{ form.pertencentes }}
      </div>
      <div class="col-12">
        <label class="form-label">{{ form.observacoes.label }}</label>
        {{ form.observacoes }}
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-success" type="submit">Salvar</button>
        <a class="btn btn-outline-secondary" href="{% url 'os_app:listar_os' %}">Cancelar</a>
      </div>
    </div>
  </form>

  {# ------------------ JS: preencher campos do objeto quando editar ------------------ #}
  <script>
    (function(){
      // ler endpoints do div #os-api-urls (se presente) ou usar fallback com placeholder /0/
      var urlsEl = document.getElementById('os-api-urls');
      var apiObjetoDetail = urlsEl ? urlsEl.getAttribute('data-obj-detail')  : "{% url 'os_app:api_objeto_detail' 0 %}";
      var apiPorProprietario = urlsEl ? urlsEl.getAttribute('data-por-proprietario') : "{% url 'os_app:api_objetos_por_proprietario' 0 %}";

      function qs(id){ return document.getElementById(id); }

      // elementos (pode ser que alguns venham do form.render)
      const idObjField = qs('id_idobjeto') || qs('id_idobjeto'); // pode ser input hidden ou select
      const tipoEl = qs('id_tipo_objeto') || qs('id_tipo_objeto');
      const marcaEl = qs('id_marca') || qs('id_marca');
      const modeloEl = qs('id_modelo') || qs('id_modelo');
      const placaEl = qs('id_placa') || qs('id_placa');
      const descEl = qs('id_descricaoobjeto');
      const proprietarioSelect = qs('id_proprietario');

      if(descEl) descEl.readOnly = true;

      function montarDescricao(){
        const t = tipoEl && tipoEl.value ? tipoEl.value.trim() : '';
        const m = marcaEl && marcaEl.value ? marcaEl.value.trim() : '';
        const mo = modeloEl && modeloEl.value ? modeloEl.value.trim() : '';
        const p = placaEl && placaEl.value ? placaEl.value.trim() : '';
        const parts = [];
        if(t) parts.push(t);
        if(m) parts.push(m);
        if(mo) parts.push(mo);
        let s = parts.join(' - ');
        if(p) s = (s ? (s + ' - ') : '') + 'PLACA: ' + p;
        if(descEl) descEl.value = s;
      }

      function replaceZero(urlTemplate, id){
        if(!urlTemplate) return null;
        if(urlTemplate.indexOf('/0/') !== -1) return urlTemplate.replace('/0/', '/' + encodeURIComponent(id) + '/');
        return urlTemplate.replace(/0(\/)?$/, encodeURIComponent(id) + '$1');
      }

      function preencherPorObjeto(id){
        if(!id) return;
        var url = replaceZero(apiObjetoDetail, id) || apiObjetoDetail;
        fetch(url).then(r => r.json()).then(data => {
          if(!data || data.error) return;
          if(tipoEl) tipoEl.value = data.tipo || '';
          if(marcaEl) marcaEl.value = data.marca || '';
          if(modeloEl) modeloEl.value = data.modelo || '';
          if(placaEl) placaEl.value = data.placa || '';
          montarDescricao();
        }).catch(err => console.error('Erro ao obter detalhe do objeto:', err));
      }

      document.addEventListener('DOMContentLoaded', function(){
        if(proprietarioSelect){
          proprietarioSelect.addEventListener('change', function(){
            const cid = this.value;
            const objetosSelect = qs('id_idobjeto');
            if(objetosSelect) objetosSelect.innerHTML = '<option value="">(nenhum)</option>';
            if(!cid) return;
            var url = replaceZero(apiPorProprietario, cid) || apiPorProprietario;
            fetch(url).then(r => r.json()).then(data => {
              if(data && data.objects && objetosSelect){
                data.objects.forEach(o => {
                  const opt = document.createElement('option');
                  opt.value = o.id;
                  opt.text = o.label;
                  objetosSelect.appendChild(opt);
                });
              }
            }).catch(err => console.error('Erro ao buscar objetos:', err));
          });

          // se existir select de objetos e já houver um value inicial no form (idobjeto), marcar opção e preencher
          const objetosSelectInit = qs('id_idobjeto');
          try {
            const existing = "{{ os.idobjeto|default:''|escapejs }}";
            if(objetosSelectInit && existing){
              const opt = document.createElement('option');
              opt.value = existing;
              opt.text = 'Carregando...';
              objetosSelectInit.appendChild(opt);
              objetosSelectInit.value = existing;
              preencherPorObjeto(existing);
            }
          } catch(e){}
        }

        try {
          const osIdObj = "{{ os.idobjeto|default:''|escapejs }}";
          let idFromField = '';
          if(idObjField && idObjField.value) idFromField = idObjField.value;
          const finalId = idFromField || osIdObj;
          if(finalId){
            preencherPorObjeto(finalId);
            if(idObjField && !idObjField.value) idObjField.value = finalId;
          } else {
            montarDescricao();
          }
        } catch(e){
          montarDescricao();
        }

        [tipoEl, marcaEl, modeloEl, placaEl].forEach(function(el){
          if(!el) return;
          el.addEventListener('input', montarDescricao);
        });
      });
    })();
  </script>
{% endblock %}
